{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="mb-4">
                <a href="{% url 'tasks:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>

            {% if messages %}
            <div class="messages mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div id="taskDetail" class="card loading-state">
                {% include "tasks/partials/task_detail.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/api.js"></script>
<script>
    let isUsingApi = false;
    let currentUser = null;
    let isLoading = false;
    const taskUuid = window.location.pathname.split('/')[2];

    // Helper function to show loading state
    function showLoading(elementId, message = 'Loading...') {
        const element = document.getElementById(elementId);
        const existingOverlay = element.querySelector('.loading-overlay');
        if (!existingOverlay) {
            element.insertAdjacentHTML('beforeend', `
                <div class="loading-overlay">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">${message}</p>
                    </div>
                </div>
            `);
        }
    }

    // Helper function to hide loading state
    function hideLoading(elementId) {
        const element = document.getElementById(elementId);
        const overlay = element.querySelector('.loading-overlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Get status color
    function getStatusColor(status) {
        switch(status) {
            case 'completed': return 'success';
            case 'in_progress': return 'warning';
            case 'pending': return 'secondary';
            default: return 'primary';
        }
    }

    // Create task detail HTML
    function createTaskDetailTemplate(task) {
        return `
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">${task.title}</h3>
                <div class="btn-group">
                    ${task.created_by === currentUser ? `
                        <a href="/tasks/${task.uuid}/edit/" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-1"></i>Edit
                        </a>
                        <button onclick="deleteTask('${task.uuid}')" class="btn btn-outline-danger">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    ` : ''}
                </div>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h5>Description</h5>
                    <p>${task.description}</p>
                </div>

                <div class="mb-4">
                    <h5>Due Date</h5>
                    <p>${new Date(task.due_date).toLocaleDateString()}</p>
                </div>

                <div class="mb-4">
                    <h5>Assigned Users</h5>
                    <ul class="list-group">
                        ${task.user_assignments.map(ua => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${ua.user.username}
                                <div>
                                    ${ua.user.id === currentUser ? `
                                        <select class="form-select form-select-sm d-inline-block w-auto me-2" 
                                                onchange="updateTaskStatus('${task.uuid}', this.value)">
                                            <option value="pending" ${ua.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="in_progress" ${ua.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="completed" ${ua.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    ` : `
                                        <span class="badge bg-${getStatusColor(ua.status)}">${ua.status}</span>
                                    `}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <div class="mb-4">
                    <h5>Task Information</h5>
                    <p class="mb-1"><strong>Created by:</strong> ${task.created_by_name}</p>
                    <p class="mb-1"><strong>Created at:</strong> ${new Date(task.created_at).toLocaleString()}</p>
                    <p class="mb-1"><strong>Last updated:</strong> ${new Date(task.updated_at).toLocaleString()}</p>
                </div>
            </div>
        `;
    }

    // Load task details using API
    async function loadTaskDetails() {
        if (!isUsingApi || isLoading) return;

        isLoading = true;
        showLoading('taskDetail', 'Loading task details...');

        try {
            const task = await API.tasks.get(taskUuid);
            document.getElementById('taskDetail').innerHTML = createTaskDetailTemplate(task);
        } catch (error) {
            console.error('Error loading task details:', error);
            document.getElementById('taskDetail').innerHTML = `
                <div class="card-body">
                    <div class="alert alert-danger">
                        Failed to load task details. Please try again.
                    </div>
                </div>
            `;
        } finally {
            hideLoading('taskDetail');
            isLoading = false;
        }
    }

    // Update task status
    async function updateTaskStatus(taskUuid, status) {
        if (!isUsingApi) {
            window.location.href = `/tasks/${taskUuid}/status/${status}/`;
            return;
        }

        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.classList.add('btn-loading');
        btn.innerHTML = `
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Updating...
        `;

        try {
            await API.tasks.updateStatus(taskUuid, status);
            await loadTaskDetails();
        } catch (error) {
            console.error('Error updating task status:', error);
            alert('Failed to update task status. Please try again.');
        } finally {
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            btn.innerHTML = originalHtml;
        }
    }

    // Delete task
    async function deleteTask(taskUuid) {
        if (!confirm('Are you sure you want to delete this task?')) return;

        const btn = event.target;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.classList.add('btn-loading');
        btn.innerHTML = `
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            Deleting...
        `;

        try {
            if (isUsingApi) {
                await API.tasks.delete(taskUuid);
            } else {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/tasks/${taskUuid}/delete/`;
                
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
                form.appendChild(csrfInput);
                
                document.body.appendChild(form);
                form.submit();
                return;
            }
            window.location.href = '/tasks/';
        } catch (error) {
            console.error('Error deleting task:', error);
            alert('Failed to delete task. Please try again.');
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            btn.innerHTML = originalHtml;
        }
    }

    // Toggle real-time updates
    function toggleRealTimeUpdates(enabled) {
        isUsingApi = enabled;
        if (enabled) {
            loadTaskDetails();
        } else {
            window.location.reload();
        }
    }

    // Initialize
    (async () => {
        try {
            const userResponse = await API.user.me();
            currentUser = userResponse.id;
        } catch (error) {
            console.error('Error getting current user:', error);
        }
    })();

    // Auto-refresh when using API
    setInterval(() => {
        if (isUsingApi && !isLoading) {
            loadTaskDetails();
        }
    }, 30000); // Refresh every 30 seconds
</script>
{% endblock %}